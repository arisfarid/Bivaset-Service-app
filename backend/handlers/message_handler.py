from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from utils import get_categories, get_user_phone, log_chat
import logging
from handlers.category_handler import handle_category_selection
from handlers.location_handler import handle_location
from handlers.attachment_handler import handle_attachment
from handlers.project_details_handler import handle_project_details
from handlers.state_handler import handle_project_states
from handlers.start_handler import check_phone
from handlers.view_handler import handle_view_projects
from keyboards import REGISTER_MENU_KEYBOARD, EMPLOYER_MENU_KEYBOARD, CONTRACTOR_MENU_KEYBOARD, MAIN_MENU_KEYBOARD
from asyncio import Lock

logger = logging.getLogger(__name__)

START, REGISTER, ROLE, EMPLOYER_MENU, CATEGORY, SUBCATEGORY, DESCRIPTION, LOCATION_TYPE, LOCATION_INPUT, DETAILS, DETAILS_FILES, DETAILS_DATE, DETAILS_DEADLINE, DETAILS_BUDGET, DETAILS_QUANTITY, SUBMIT, VIEW_PROJECTS, PROJECT_ACTIONS = range(18)

# Ø§ÛŒØ¬Ø§Ø¯ Ù‚ÙÙ„ Ø³Ø±Ø§Ø³Ø±ÛŒ
message_lock = Lock()

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    text = update.message.text
    current_state = context.user_data.get('state', ROLE)
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
    if not await check_phone(update, context):
        return REGISTER
        
    if text == "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø¯Ù…Ø§Øª | Ú©Ø§Ø±ÙØ±Ù…Ø§ ðŸ‘”":
        # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† context Ùˆ ØªÙ†Ø¸ÛŒÙ… state Ø¬Ø¯ÛŒØ¯
        context.user_data.clear()
        context.user_data['state'] = EMPLOYER_MENU
        
        # Ø§Ø±Ø³Ø§Ù„ Ù…Ù†ÙˆÛŒ Ú©Ø§Ø±ÙØ±Ù…Ø§
        await update.message.reply_text(
            "ðŸŽ‰ Ø¹Ø§Ù„ÛŒÙ‡ØŒ {}! Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø®Ø¯Ù…Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù†ÛŒ ÛŒØ§ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒØŸ".format(
                update.effective_user.full_name
            ),
            reply_markup=EMPLOYER_MENU_KEYBOARD
        )
        logger.info(f"User {update.effective_user.id} entered employer menu")
        return EMPLOYER_MENU

    elif text == "ðŸ“‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø¯Ù…Ø§Øª Ø¬Ø¯ÛŒØ¯":
        # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† context Ùˆ ØªÙ†Ø¸ÛŒÙ… state Ø¬Ø¯ÛŒØ¯
        context.user_data.clear()
        context.user_data['state'] = CATEGORY
        context.user_data['files'] = []
        
        # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
        categories = await get_categories()
        if not categories:
            await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§")
            return EMPLOYER_MENU
            
        context.user_data['categories'] = categories
        root_cats = [cat_id for cat_id, cat in categories.items() if cat['parent'] is None]
        keyboard = [[KeyboardButton(categories[cat_id]['name'])] for cat_id in root_cats]
        keyboard.append([KeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª")])
        
        await update.message.reply_text(
            "ðŸŒŸ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Ø§ØªØª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
            reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        )
        logger.info(f"User {update.effective_user.id} started new request")
        return CATEGORY

    return current_state

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data.clear()
    await update.message.reply_text("Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†!")
    return ConversationHandler.END